<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8097329174824434" crossorigin="anonymous"></script><link rel="preload" href="/_next/static/css/1386383271a5d05d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1386383271a5d05d.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-e7f9a8f407d6abab.js" defer=""></script><script src="/_next/static/chunks/framework-bb5c596eafb42b22.js" defer=""></script><script src="/_next/static/chunks/main-5b1095b7dd901b1a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-a21fb48766517705.js" defer=""></script><script src="/_next/static/chunks/186-52595008a9b3875f.js" defer=""></script><script src="/_next/static/chunks/55-818e347ebc0aa2d2.js" defer=""></script><script src="/_next/static/chunks/463-c79017b7d878f8c9.js" defer=""></script><script src="/_next/static/chunks/864-ad47463ba6522ce4.js" defer=""></script><script src="/_next/static/chunks/pages/note/tags/%5Btag%5D-6fd6ac7f9e47b8ac.js" defer=""></script><script src="/_next/static/1789b1769d6a4944e6c6328f26925e21485d6dfa/_buildManifest.js" defer=""></script><script src="/_next/static/1789b1769d6a4944e6c6328f26925e21485d6dfa/_ssgManifest.js" defer=""></script><script src="/_next/static/1789b1769d6a4944e6c6328f26925e21485d6dfa/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="w-full mx-auto antialiased max-w-3xl xl:max-w-5xl"><div class="mx-8 sm:mx-10 md:mx-12 py-10"><main role="main" class="divide-y divide-gray-200"><div class="py-4"><h1 class="text-4xl tracking-tight font-extrabold text-gray-900"># SQL</h1><p class="mt-3 text-xl text-gray-500 sm:mt-4"><span class="text-pink-600">1</span> posts in<!-- --> <span class="font-bold text-black"># <!-- -->SQL</span></p></div><div aria-label="preview" class="mx-auto"><ul class="divide-y divide-gray-200"><li class="py-4"><div class="mb-4 pt-4"><div class="flex flex-col space-y-8"><div class="flex flex-col space-y-1"><div class="pt-1.5 flex justify-between items-center"><a role="link" href="/note/oneline_sqlite/"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900">ワンライナーで CSV に対して SQLite クエリを実行する</h2></a></div><div class="text-sm sm:text-base whitespace-nowrap text-gray-500"><div class="sr-only">Published on</div><time dateTime="2022-06-21">June 21, 2022<!-- --> (<!-- -->16 days ago<!-- -->)</time></div><div aria-label="タグ一覧" class="flex flex-wrap gap-2"><a role="link" class="w-max inline-flex rounded-sm bg-blue-100 hover:bg-blue-600 px-2 py-0.5 text-sm" href="/note/tags/SQL/"><span class="font-medium text-blue-700 hover:text-white"># <!-- -->SQL</span></a><a role="link" class="w-max inline-flex rounded-sm bg-blue-100 hover:bg-blue-600 px-2 py-0.5 text-sm" href="/note/tags/SQLite/"><span class="font-medium text-blue-700 hover:text-white"># <!-- -->SQLite</span></a></div></div><div class="flex flex-col space-y-6"><div class="prose sm:prose-sm md:prose-md"><p><a href="https://til.simonwillison.net/sqlite/one-line-csv-operations">One-liner for running queries against CSV files with SQLite</a> という記事で紹介されていた、ワンライナーを使って CSV ファイルに対して SQL クエリを実行する方法。</p>
<pre><code class="language-bash">$ sqlite3 :memory: -cmd &#x27;.mode csv&#x27; -cmd &#x27;.import taxi.csv taxi&#x27; \
  &#x27;SELECT passenger_count, COUNT(*), AVG(total_amount) FROM taxi GROUP BY passenger_count&#x27;
</code></pre>
<p>ソース元に記述されてる通り、<a href="https://github.com/multiprocessio/dsq/blob/43e72ff1d2c871082fed0ae401dd59e2ff9f6cfe/testdata/taxi.csv.7z">taxi.csv</a> を GitHub からダウンロードして試すことができる。7z で圧縮されていて解凍する必要がある。</p>
<p>SQLite は通常ストレージディスク（SSD とか）上に保存して利用するのが一般的だが、SQLite 側で用意されている特別なファイル名 <code>:memory:</code> を指定して開くことでデータをインメモリで扱うことができる。これについては SQLite の <a href="https://www.sqlite.org/inmemorydb.html">In-Memory Databases
</a><sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup> のページで紹介されている。</p>
<p>taxi.csv の中身はこんな感じの CSV ファイル。</p>
<section data-footnotes="true" class="footnotes"><h2 id="footnote-label" class="sr-only">Footnotes</h2>
<ol>
<li id="user-content-fn-1">
<p>これは <a href="https://www.sqlite.org/vtab.html">virtual table API</a> を利用して実現されているらしい。この API は全文検索でも利用されているっぽい。 <a href="#user-content-fnref-1" data-footnote-backref="true" class="data-footnote-backref" aria-label="Back to content">↩</a></p>
</li>
</ol>
</section></div><div class="flex text-base font-medium"><a role="link" class="text-teal-600 hover:text-teal-700" aria-label="ワンライナーで CSV に対して SQLite クエリを実行するの続きを読む" href="/note/oneline_sqlite/">Read more →</a></div></div></div></div></li><li class="py-4"></li></ul></div></main></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"itemLinks":["/note/oneline_sqlite"],"tag":"SQL"},"__N_SSG":true},"page":"/note/tags/[tag]","query":{"tag":"SQL"},"buildId":"1789b1769d6a4944e6c6328f26925e21485d6dfa","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>